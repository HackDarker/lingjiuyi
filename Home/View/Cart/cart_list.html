

<link href="__PUBLIC__/Home/css/cartstyle.css" rel="stylesheet" type="text/css" />
		<link href="__PUBLIC__/Home/css/optstyle.css" rel="stylesheet" type="text/css" />

		<!--购物车 -->
		<div class="concent">
			<div id="cartTable">
				<div class="cart-table-th">
					<div class="wp">
						<div class="th th-chk">
							<div id="J_SelectAll1" class="select-all J_SelectAll">

							</div>
						</div>
						<div class="th th-item">
							<div class="td-inner">商品信息</div>
						</div>
						<div class="th th-price">
							<div class="td-inner">单价</div>
						</div>
						<div class="th th-amount">
							<div class="td-inner">数量</div>
						</div>
						<div class="th th-sum">
							<div class="td-inner">金额</div>
						</div>
						<div class="th th-op">
							<div class="td-inner">操作</div>
						</div>
					</div>
				</div>
				<div class="clear"></div>

				<tr class="item-list">
					<div class="bundle  bundle-last ">
						<div class="bundle-hd">
							<div class="bd-promos">
								<div class="bd-has-promo">已享优惠:<span class="bd-has-promo-content">省￥0元</span>&nbsp;&nbsp;</div>
								<div class="act-promo">
									<a href="#" target="_blank">第二支半价，第三支免费<span class="gt">&gt;&gt;</span></a>
								</div>
								<span class="list-change theme-login">编辑</span>
							</div>
						</div>
						<div class="clear"></div>
						<div class="bundle-main">
						<volist name="carts" id="vol">
							<ul class="item-content clearfix" goods_id="{$vol.goods_id}" goods_attr_ids="{$vol.goods_attr_ids}" cart_id="{$vol.id|default=0}">
								<li class="td td-chk">
									<div class="cart-checkbox ">
										<input class="check row_check" name="items[]" value="170037950254" type="checkbox">
										<label for="J_CheckBox_170037950254"></label>
									</div>
								</li>
								<li class="td td-item">
									<div class="item-pic">
										<a href="__MODULE__/Index/detail/id/{$vol.goods_id}" target="_blank" data-title="{$vol.goods.goods_name}" class="J_MakePoint" data-point="tbcart.8.12">
											<img src="__PUBLIC__/Uploads{$vol.goods.goods_small_img}" style="width: 100%;" class="itempic J_ItemImg"></a>
									</div>
									<div class="item-info">
										<div class="item-basic-info">
											<a href="__MODULE__/Index/detail/id/{$vol.goods_id}" target="_blank" title="{$vol.goods.goods_name}" class="item-title J_MakePoint" data-point="tbcart.8.11">{$vol.goods.goods_name}</a>
										</div>
									</div>
								</li>
								<li class="td td-info">
									<div class="item-props item-props-can">
									<volist name="vol.attr" id="vol_attr">
										<span class="sku-line">{$vol_attr.attr_name} : {$vol_attr.attr_value}&emsp;</span>
									</volist>
										<span tabindex="0" class="btn-edit-sku theme-login">修改</span>
										<i class="theme-login am-icon-sort-desc"></i>
									</div>
								</li>
								<li class="td td-price">
									<div class="item-price price-promo-promo">
										<div class="price-content">
											<div class="price-line">
												<em class="price-original">{$vol.goods.goods_bigprice}</em>
											</div>
											<div class="price-line">
												<em class="J_Price price-now" tabindex="0">{$vol.goods.goods_price}</em>
											</div>
										</div>
									</div>
								</li>
								<li class="td td-amount">
									<div class="amount-wrapper ">
										<div class="item-amount ">
											<div class="sl">
												<input class="min am-btn sub_number" name="" type="button" value="-" />
												<input class="text_box current_number" name="" type="text" value="{$vol.number}" style="width:30px;" />
												<input class="add am-btn add_number" name="" type="button" value="+" />
											</div>
										</div>
									</div>
								</li>
								<li class="td td-sum">
									<div class="td-inner">
										<em tabindex="0" class="J_ItemSum number row_price">{$vol['goods']['goods_price'] * $vol['number']}</em>
									</div>
								</li>
								<li class="td td-op">
									<div class="td-inner">
										<a title="移入收藏夹" class="btn-fav" href="#"> 移入收藏夹</a>
										<a href="javascript:;" data-point-url="#" class="delete"> 删除</a>
									</div>
								</li>
							</ul>
						</volist>
						</div>
					</div>
				</tr>
				<div class="clear"></div>
			</div>
			<div class="clear"></div>

			<div class="float-bar-wrapper">
				<div id="J_SelectAll2" class="select-all J_SelectAll">
					<div class="cart-checkbox">
						<input class="check-all check" name="select-all" value="true" type="checkbox">
						<label for="J_SelectAllCbx2"></label>
					</div>
					<span>全选</span>
				</div>
				<div class="operations">
					<a href="#" hidefocus="true" class="deleteAll">删除</a>
					<a href="#" hidefocus="true" class="J_BatchFav">移入收藏夹</a>
				</div>
				<div class="float-bar-right">
					<div class="amount-sum">
						<span class="txt">已选商品</span>
						<em id="J_SelectedItemsCount">0</em><span class="txt">件</span>
						<div class="arrow-box">
							<span class="selected-items-arrow"></span>
							<span class="arrow"></span>
						</div>
					</div>
					<div class="price-sum">
						<span class="txt">合计:</span>
						<strong class="price">¥<em id="J_Total">0.00</em></strong>
					</div>
					<div class="btn-area">
						<a href="javascript:void(0);" id="J_Go" class="submit-btn submit-btn-disabled" aria-label="请注意如果没有选择宝贝，将无法结算">
							<span>结&nbsp;算</span></a>
					</div>
				</div>

			</div>
		</div>
<script type="text/javascript">
	$(function(){
		//封装发送ajax修改购买数量的函数
		var changenumber = function(element,new_number) {
			var goods_id = $(element).closest('ul').attr('goods_id');
			var goods_attr_ids = $(element).closest('ul').attr('goods_attr_ids');
			var data = {
				'goods_id':goods_id,
				'goods_attr_ids':goods_attr_ids,
				'number':new_number
			};

			$.ajax({
				'url':'__CONTROLLER__/changenumber',
				'type':'post',
				'data':data,
				'dataType':'json',
				'success':function(response){
					if(response.code != 10000){
						alert(response.msg);
						return;
					}else{
						var current_number_obj = $(element).closest('li').find('.current_number');
						current_number_obj.val(new_number);
						$('#J_MiniCartNum').text(response.total);
						$('#cart_num').html(response.total);
						getTotal();
						//
						var price = parseFloat($(element).closest('ul').find('.price-now').text());
						var row_price = price * parseInt(new_number);
						//
						$(element).closest('ul').find('.row_price').text(row_price);
					}
				}
			});

		};

		var getTotal = function(){
			//获取到已选的购物记录
			var checked_checkbox = $('.row_check:checked');
			var total_number = 0;
			var total_price = 0;
			var youhui_price = 0;
			$.each(checked_checkbox,function(i,v){
				var row_number = parseInt($(v).closest('ul').find('.current_number').val());
				total_number += row_number;
				var row_price = parseFloat($(v).closest('ul').find('.price-now').text());
				total_price += total_number * row_price;
				var row_bigprice = parseFloat($(v).closest('ul').find('.price-original').text());
				youhui_price = parseInt(row_bigprice - total_price);
			});
			$('#J_SelectedItemsCount').text(total_number);
			$('#J_Total').text(total_price);
			$('.bd-has-promo-content').text(youhui_price);
		}


		//增加商品数量
		$('.add_number').click(function(){
			//获取原始数量(页面当前显示的数量)
			//获取到当前行记录中的input输入框
			var current_number_obj = $(this).closest('li').find('.current_number');
			//获取当前input输入框的值
			var current_number = current_number_obj.val();
			// console.log(current_number);
			//计算新的数量
			var new_number = parseInt(current_number) + 1;
			// console.log(new_number);
			changenumber(this,new_number);
			
		});

		//减少数量的事件
		$('.sub_number').click(function(){
			var current_number_obj = $(this).closest('li').find('.current_number');
			var current_number =  current_number_obj.val();

			if(current_number == 1){
				return;
			}
			var new_number = parseInt(current_number) - 1;
			changenumber(this,new_number);
		});

		$('.current_number').change(function(){
			var new_number = $(this).val();
			//检测输入的值
			//对于数组,使用parseInt转化成整数
			new_number = parseInt(new_number);
			//对于字母,转化之后 为 isNaN		isNaN('123')=>false	isNaN(123)=>false	isNaN(adv)=>true
			// console.log(new_number);
			if(isNaN(new_number) || new_number < 1){
				return;
			}
			//发送ajax
			changenumber(this,new_number);
		});

		//删除购物记录
		$('.delete').click(function(){
			//ajax请求需要的参数
			var goods_id = $(this).closest('ul').attr('goods_id');
			var goods_attr_ids = $(this).closest('ul').attr('goods_attr_ids');
			var data ={
				'goods_id':goods_id,
				'goods_attr_ids':goods_attr_ids
			};
			var _this = this;
			//发送ajax,从购物车数据中删除指定的一条记录
			$.ajax({
				'url':'__CONTROLLER__/delcart',
				'type':'post',
				'data':data,
				'dataType':'json',
				'success':function(response){
					if(response.code != 10000){
						alert(response.msg);
						return;
					}else{
						//获取当前行的ul标签,从页面移除
						//在页面上移除指定的记录的显示
						$(_this).closest('ul').remove();
						//显示头部购物车总数量
						$('#J_MiniCartNum').text(response.total);
						$('#cart_num').html(response.total);
						//重新计算已选商品的总价格和数量
						getTotal();
					}
				}
			});
		});

		//给单个checkbox绑定onchange事件
		$('.row_check').change(function(){
			//计算已选的总数量和总价格
			getTotal();
			//获取总行数(获取 row_check 的数量)
			var checkbox_total = $('.row_check').length;
			//获取选中的 checkbox 的数量
			var checkbox_checked = $('.row_check:checked').length;
			//判断 两个数量
			if(checkbox_total == checkbox_checked){
				//每一行的checkbox都选中了,全选
				$('.check-all').prop('checked',true);
			}else{
				//全选不勾选
				$('.check-all').prop('checked',false);
			}
		});

		//给全选checkbox绑定onchange事件
		$('.check-all').change(function(){
			//获取全选checkbox的选中状态(checked)
			// var checked_attr = $(this).attr('checked');
			var checked_attr = $(this).prop('checked');
			//吧全选checkbox的状态同步到每一行的checkbox上
			$('.row_check').prop('checked',checked_attr);
			//重新计算已选商品数量和价格
			getTotal();
		});
		
		//给结算按钮绑定onclick事件
		$('#J_Go').click(function(){
			//获取选中的checkbox
			var checked_checkbox = $('.row_check:checked');
			if(checked_checkbox.length < 1){
				return;
			}
			//拼接
			var ids = '';
			//遍历选中的checkbox
			$.each(checked_checkbox,function(i,v){
				//v表示一个document元素对象,需要转化为jQuery对象
				//根据选中的checkbox,向上查找ul中自定义的cart_id
				var cart_id = $(v).closest('ul').attr('cart_id');
				//如果cart_id不为0
				if(cart_id > 0){
					//拼接
					ids += cart_id+',';
				}
			});
			//去除结尾逗号
			ids = ids.slice(0,-1);
			//携带参数跳转到结算页面
			var url = "__CONTROLLER__/flow2/ids/"+ids;
			location.href = url;
		});
	
	});
</script>